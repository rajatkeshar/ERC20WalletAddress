<html>
	<head>
		<title>Cross-Browser QRCode generator for Eleven01</title>
		<script type="text/javascript" src="../js/qrcode.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
		<style>
		    .ul_font_size {
		        font-size: 25px;
		        text-align: center;
		    }
		    .row-class {
		        margin-bottom: 5px;
		        margin-top: 20px;
		        background: white;
		        height: 45px;
		        padding-top: 10px
		    }
		    .th-style {
		        font-size: 22px;
		        text-align: center;
		        color: black;
		        font-size: 20px;
		    }
		    .panel.panel-info {
		        position: relative;
		        top: 90px;
		    }
		    .send-btn {
		        margin-bottom: 10px !important;
		        margin-right: 13px;
		    }
		    .send-btn-div {
		        text-align: right;
		        margin-top: 10;
		    }
			.d-inline{
				text-align: right;
			}
			p{
				position: relative;
				bottom: 48px;
			}
		    input#create-wallet{
		        background: 195399;
				
				top: 80px;
				width: 200px;
				left: 70px;
			}
			input#passphrase{
				position: relative;
				top: 40px;
			}
			.panel.panel-login{
				position: relative;
				right: 50px;
				top: 65px;
		    }
		</style>
	</head>
	<body>
		<style>
			body {
				background-color: #0bbe90;
			}
		</style>
		
	    <div class="container" style="padding-top: 50px;">
        	<p class="col-md-6 col-md-offset-4" style="padding-top: 50px;"><img src="../img/eleven01.png"></img></p>    
			<div class="col-md-6 col-md-offset-3">	
                <div class="panel panel-login">
                    <div class="panel-body">
                        <form>
                            <div class="form-group">
								<div id="msg" style="display:none"></div>
                                <input type="text" name="password" id="password" tabindex="1" class="form-control" placeholder="Enter a password" value="">
								<input type="button" name="download-keystore" id="download-keystore" tabindex="4" class="form-control btn-primary" value="Download Keystore File {UTC/json}" style="display:none">                            
								</div>
								<div id="privateKey" style="display:none"></div>
								<input type="button" name="print-wallet" id="print-wallet" tabindex="4" class="form-control btn-primary" value="Print Paper Wallet" style="display:none">
             
								</div>
                            <div class="form-group">
                                <div class="col-sm-6 col-sm-offset-3">
                                    <input type="button" name="create-wallet" id="create-wallet" tabindex="4" class="form-control btn-primary" value="Create New Wallet">
								<input type="button" name="save-address" id="save-address" tabindex="4" class="form-control btn-primary" value="Save Address" style="display:none">                            
								<input type="button" name="next" id="next" tabindex="4" class="form-control btn-primary" value="I Understand & Continue" style="display:none; color:red">           
								</div>
                                </div>
                            </div>
                        </form>  
                    </div>
                </div>
	        </div>
		</div>
		<div class="container" style="padding-top: 150px;" align="center"> 
			<p id="qrcode1" style="display: inline-block;padding-right:5em"></p>
			<p id="qrcode2" style="display: inline-block;padding-right:7em"></p>
		</div>
		<script type="text/javascript">

			$(document).ready(function() {

				var base_url = 'http://localhost:3030';
				var privateKey = '';
				var address = '';
				var password = '';

				$("#create-wallet").click(function() {
                	password = $("#password").val();
					$.ajax({
		                type: 'GET',
		                url: base_url + '/new',
		                dataType: 'json',
		                success: function(res) {
		                    if (res) {
								console.log("randomWallet: ", res);
		                        privateKey = res.privateKey;
								address = res.address;
								$("#create-wallet").hide();
								$('#password').hide();
								$('#msg').show();
								$('#msg').html('<h4 align="center">Save Your <b style="color:red; background:#FFEEEE">Keystore</b> File</h4>');
								$('#download-keystore').show();
								$('#next').show();
								
		                    } else {
								return alert(JSON.stringify(res));
							}
		                }
		            });	
				});
				$('#download-keystore').click(function() {
					var payload = { privateKey: privateKey, password: password };

					console.log("payload: ", payload);					
					/*$.ajax({
		                type: 'POST',
		                url: base_url + '/generateKeystore',
		                data: payload,
		                dataType: 'json',
		                success: function(res) {
		                    if (res) {
		                        console.log("generateKeysytore: ", res);
		                    } else {
								return alert(JSON.stringify(res));
							}
		                }
		            });*/	
					axios.post(base_url + '/generateKeystore', payload)
					  .then(function (res) {
						data = JSON.parse(res.data.keystore);
						console.log("generateKeysytore: ", data);
						address = data.address;
						const filename = `UTC--${new Date().toISOString().replace(/[:]/g, '-')}--${address}`;
						console.log("download-keystore");
						download(filename, data);
					  })
					  .catch(function (error) {
						console.log(error);
					  });
				});
				$('#next').click(function() {
					$('#download-keystore').hide();
					$('#next').hide();
					$('#print-wallet').show();
					$('#save-address').show();
					$('#msg').html('<h6 align="center">Save Your PrivateKey: <b style="color:red; background:#FFEEEE">"'+privateKey+'"</b></h6>');
				});
				$('#save-address').click(function() {
					$('#print-wallet').hide();
					$('#save-address').hide();
					$('#msg').html('<h5 align="center">Save Your Address: <b style="color:red; background:#FFEEEE">"'+address+'"</b></h5>');
				});
				$('#print-wallet').click(function() {
					console.log("calling paper-wallet");
					$('#qrcode1').show();
					$('#qrcode2').show();
					$('#qrcode1').html("<h4>Address</h4>");
					$('#qrcode2').html("<h4>Private Key</h4>");
		
					var qrCodeAddress = generateQRCode("qrcode1");
					qrCodeAddress.clear();
					qrCodeAddress.makeCode(address);

					var qrCodePrivateKey = generateQRCode("qrcode2");
					qrCodePrivateKey.clear();
					qrCodePrivateKey.makeCode(privateKey);
					
				});
				function download(filename, text) {
					var element = document.createElement('a');
					element.setAttribute('href', 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(text)));
					element.setAttribute('download', filename);

					element.style.display = 'none';
					document.body.appendChild(element);

					element.click();

					document.body.removeChild(element);
				}

				function generateQRCode(element) {
					var qrCode = new QRCode(element, {
						text: "_blank",
						width: 177,
						height: 177,
						colorDark: "#000000",
						colorLight: "#ffffff",
						correctLevel: QRCode.CorrectLevel.H
					});

					return qrCode;
				}	
			});
		</script>
	</body>
</html>
